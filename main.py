import disnake
from disnake.ext import commands, tasks
import aiohttp
from datetime import datetime
import os

bot = commands.Bot(command_prefix="/", intents=disnake.Intents.all())

async def fetch_exploit_status():
    async with aiohttp.ClientSession() as session:
        async with session.get('https://api.whatexploitsare.online/status') as response:
            data = await response.json()
    return data

async def fetch_sirhurt_status():
    async with aiohttp.ClientSession() as session:
        async with session.get('https://sirhurt.net/status/fetch.php?exploit=SirHurt%20V4') as response:
            data = await response.json()
    return data

def create_embed(data, sirhurt_data):
    embed = disnake.Embed(title="Exploit Status", color=0x303134)
    embed.set_author(name="Exploit Checker", icon_url="https://cdn.discordapp.com/icons/920129627345809418/bd87703cccaa0273d376931a5443ffc5.webp")
    embed.set_footer(text="Made by vemorr âœ¦ Updates every 20 seconds")
    embed.set_image(url="https://cdn.discordapp.com/banners/920129627345809418/b4e3e1f80067e84911fcf9fb80385267.jpg?size=2048")

    for item in data:
        for name in item:
            if name == 'ROBLOX':
                pass
            else:
                if name == 'Script-Ware':
                    display_name = f"<:scriptware:1102898747987468379> Script-Ware Windows"
                elif name == 'Synapse':
                    display_name = "<:synapse:1102898541573181571> Synapse X"
                elif name == 'KRNL':
                    display_name = f"<:krnl:1102898973653618699> {name}"
                elif name == 'DX9WARE':
                    display_name = f"<:dx9:1102899568347185162> {name}"
                elif name == 'Electron':
                    display_name = f"<:electron:1102900665023475772> {name}"
                elif name == 'WeAreDevs API':
                    display_name = f"<:wrd:1102901013997965352> {name}"
                elif name == 'Oxygen-U':
                    display_name = f"<:oxy:1102902143079415839> {name}"
                elif name == 'Fluxus':
                    display_name = f"<:fluxus:1102902398881632256> {name}"
                elif name == 'Celestial':
                    display_name = f"<:celestial:1102903337436844064> {name}"
                elif name == 'Comet':
                    display_name = f"<:comet:1102903540747341874> {name}"
                elif name == 'Elexe':
                    display_name = f"<:Elexe:1102903676793782322> {name}"
                else:
                    display_name = f"{name}"

                if item[name]['updated'] == True:
                    updated = f"<:updated:1102897728637374474>"
                elif item[name]['updated'] == False:
                    updated = f"<:notupdated:1102897722413035574>"
                if item[name]['is_free'] == True:
                    paid = f"<:notpaid:1102897720483643413>"
                elif item[name]['is_free'] == False:
                    paid = f"<:paid:1102897724669566987>"
                if item[name]['unc'] == True:
                    unc = f"\n> UNC: <:unc:1102897727341334588>"
                elif item[name]['unc'] == False:
                    unc = f"\n> UNC: <:nounc:1102897718604603484>"
                if item[name]['type'] == 'Script-Executor':
                    type = f"<:scriptexecutor:1102898500288663562>"
                elif item[name]['type'] == 'Aimbot/ESP':
                    unc = ''
                    type = f"<:aimbot:1102898540231004270>"

                if item[name]['download_url'] == '':
                    download_url = item[name]['v3rmillion_url']
                else:
                    download_url = item[name]['download_url']

                if item[name]['is_free'] == False:
                    download_url_text = 'Purchase'
                else:
                    download_url_text = 'Download'

                if item[name]['discord_url'] == item[name]['website_url']:
                    discord_url = 'https://tinyurl.com/synapse-invite'
                else:
                    discord_url = item[name]['discord_url']

                embed.add_field(name=display_name, value=f"> Updated: {updated}\n> Version: {item[name]['exploit_version']}\n> Paid: {paid}{unc}\n> Type: {type}\n> Last Update: <t:{item[name]['last_update_unix']}>\n\n**[Discord]({discord_url})**\n\n**[{download_url_text}]({download_url})**", inline=True)

    if sirhurt_data[0]['SirHurt V4']['updated'] == True:
        updated = f"<:updated:1102897728637374474>"
    elif sirhurt_data[0]['SirHurt V4']['updated'] == False:
        updated = f"<:notupdated:1102897722413035574>"

    discord_url = "https://discord.gg/Rs3Acd6MJ8"

    embed.add_field(name="<:sirhurt:1107945558758391828> SirHurt V4", value=f"> Updated: {updated}\n> Version: {sirhurt_data[0]['SirHurt V4']['exploit_version']}\n> Paid: <:paid:1102897724669566987>\n> UNC: <:unc:1102897727341334588>\n> Type: <:scriptexecutor:1102898500288663562>\n> Last Update: <t:{sirhurt_data[0]['SirHurt V4']['last_update_unix']}>\n\n**[Discord]({discord_url})**\n\n**[Purchase](https://sirhurt.net/#purchase)**", inline=True)

    return embed

@bot.event
async def on_ready():
    check_status.start()
    print("Ready")

class View(disnake.ui.View):

  def __init__(self):
    super().__init__()
    self.add_item(
      disnake.ui.Button(label="Support Me",
                        style=disnake.ButtonStyle.url,
                        url="https://www.buymeacoffee.com/vemorrr"))

@tasks.loop(seconds=20)
async def check_status():
    view = View()
    data = await fetch_exploit_status()
    sirhurt_data = await fetch_sirhurt_status()
    embed = create_embed(data, sirhurt_data)
    chanid = os.environ["CHANNELID"]

    channel = bot.get_channel(int(chanid))
    messages = await channel.history(limit=1).flatten()

    if messages and messages[0].author.id == bot.user.id:
        await messages[0].edit(embed=embed, view=view)
    else:
        await channel.purge(limit=500)
        await channel.send(embed=embed, view=view)


keep_alive()
bot.run(os.environ["TOKEN"])
